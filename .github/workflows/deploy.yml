- name: Deploy to AWS EC2
  uses: webfactory/ssh-agent@v0.9.0
  with:
    ssh-private-key: ${{ secrets.AWS_SSH_KEY }}

- name: Run remote deployment script
  run: |
    # Retry SSH up to 3 times
    for i in {1..3}; do
      if ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
           ${{ secrets.AWS_SSH_USER }}@${{ secrets.AWS_SSH_HOST }} "echo 'Connected!'; exit 0"; then
        echo "✅ SSH succeeded on attempt $i"
        break
      else
        echo "❌ SSH failed (attempt $i). Retrying..."
        sleep 5
      fi
    done

    # Now deploy
    ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
      ${{ secrets.AWS_SSH_USER }}@${{ secrets.AWS_SSH_HOST }} << 'EOF'
      docker pull thewill146/task-manager:latest
      docker stop task-manager 2>/dev/null || true
      docker rm task-manager 2>/dev/null || true
      docker run -d --name task-manager -p 80:3000 thewill146/task-manager:latest
      echo "Deployment complete."
    EOF